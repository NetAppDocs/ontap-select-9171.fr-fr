---
sidebar: sidebar 
permalink: concept_stor_vsan_external.html 
keywords: ontap select, vsan and external array configurations, vnas architecture 
summary: 'Les déploiements de NAS virtuel (vNAS) prennent en charge les clusters ONTAP Select sur vSAN, certains produits HCI, la technologie NetApp HCI et les types de banques de données externes. L"infrastructure sous-jacente de ces configurations assure la résilience des banques de données.' 
---
= ONTAP Select vSAN et configurations de baies externes
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Les déploiements de NAS virtuel (vNAS) prennent en charge les clusters ONTAP Select sur SAN virtuel (vSAN), certains produits HCI et les types de banques de données externes. L'infrastructure sous-jacente de ces configurations assure la résilience des banques de données.

La condition minimale requise est que l'hyperviseur que vous utilisez (VMware ESXi ou KVM sur un hôte Linux pris en charge) prenne en charge la configuration sous-jacente.  Si l'hyperviseur est ESXi, il doit figurer sur les listes de compatibilité matérielle (HCL) VMware correspondantes.



== Architecture vNAS

La nomenclature vNAS est utilisée pour toutes les configurations qui n'utilisent pas DAS. Pour les clusters ONTAP Select multinœuds, cela inclut les architectures où les deux nœuds ONTAP Select d'une même paire HA partagent un même datastore (y compris les datastores vSAN). Les nœuds peuvent également être installés sur des datastores distincts à partir de la même baie externe partagée. Cela permet d'optimiser l'efficacité du stockage côté baie et de réduire l'empreinte globale de l'ensemble de la paire HA ONTAP Select . L'architecture des solutions vNAS ONTAP Select est très similaire à celle d' ONTAP Select sur DAS avec un contrôleur RAID local. Autrement dit, chaque nœud ONTAP Select conserve une copie des données de son partenaire HA. Les politiques d'efficacité du stockage ONTAP sont définies par nœud. Par conséquent, l'optimisation de l'efficacité du stockage côté baie est préférable, car elle peut potentiellement s'appliquer aux ensembles de données des deux nœuds ONTAP Select .

Il est également possible que chaque nœud ONTAP Select d'une paire HA utilise une baie externe distincte. C'est un choix courant lors de l'utilisation ONTAP Select Metrocluster SDS avec stockage externe.

Lorsque vous utilisez des baies externes distinctes pour chaque nœud ONTAP Select , il est très important que les deux baies fournissent des caractéristiques de performances similaires à la machine virtuelle ONTAP Select .



=== Architectures vNAS versus DAS local avec contrôleurs RAID matériels

L'architecture vNAS est logiquement très similaire à celle d'un serveur avec DAS et contrôleur RAID. Dans les deux cas, ONTAP Select consomme de l'espace de stockage. Cet espace est découpé en VMDK, qui constituent les agrégats de données ONTAP traditionnels. ONTAP Deploy s'assure que les VMDK sont correctement dimensionnés et affectés au bon plex (dans le cas de paires HA) lors des opérations de création de cluster et d'ajout de stockage.

Il existe deux différences majeures entre un vNAS et un DAS avec contrôleur RAID. La principale différence réside dans le fait que le vNAS ne nécessite pas de contrôleur RAID. Il suppose que la baie externe sous-jacente assure la persistance et la résilience des données qu'un DAS avec contrôleur RAID offrirait. La deuxième différence, plus subtile, concerne les performances de la NVRAM .



== NVRAM vNAS

La NVRAM ONTAP Select est un VMDK. Cela signifie ONTAP Select émule un espace adressable par octet ( NVRAM traditionnel) sur un périphérique adressable par bloc (VMDK). Cependant, les performances de la NVRAM sont essentielles aux performances globales du nœud ONTAP Select .

Pour les configurations DAS avec un contrôleur RAID matériel, le cache du contrôleur RAID matériel fait office de cache NVRAM , car toutes les écritures dans le VMDK NVRAM sont d'abord hébergées dans le cache du contrôleur RAID.

Pour les architectures VNAS, ONTAP Deploy configure automatiquement les nœuds ONTAP Select avec un argument de démarrage appelé Single Instance Data Logging (SIDL). Lorsque cet argument est présent, ONTAP Select contourne la NVRAM et écrit la charge utile de données directement dans l'agrégat de données. La NVRAM sert uniquement à enregistrer l'adresse des blocs modifiés par l'opération d'écriture (WRITE). L'avantage de cette fonctionnalité est d'éviter une double écriture : une écriture dans la NVRAM et une seconde lors de la désactivation de la NVRAM . Cette fonctionnalité est uniquement activée pour les vNAS, car les écritures locales dans le cache du contrôleur RAID présentent une latence supplémentaire négligeable.

La fonctionnalité SIDL n'est pas compatible avec toutes les fonctionnalités d'optimisation du stockage ONTAP Select . Elle peut être désactivée au niveau agrégé à l'aide de la commande suivante :

[listing]
----
storage aggregate modify -aggregate aggr-name -single-instance-data-logging off
----
Notez que les performances d'écriture sont affectées si la fonctionnalité SIDL est désactivée. Il est possible de réactiver la fonctionnalité SIDL après avoir désactivé toutes les politiques d'efficacité de stockage sur tous les volumes de cet agrégat :

[listing]
----
volume efficiency stop -all true -vserver * -volume * (all volumes in the affected aggregate)
----


== Colocaliser les nœuds ONTAP Select lors de l'utilisation de vNAS sur ESXi

ONTAP Select prend en charge les clusters ONTAP Select multinœuds sur un stockage partagé. ONTAP Deploy permet la configuration de plusieurs nœuds ONTAP Select sur le même hôte ESX, à condition qu'ils ne fassent pas partie du même cluster. Notez que cette configuration est uniquement valable pour les environnements VNAS (datastores partagés). L' utilisation de plusieurs instances ONTAP Select par hôte n'est pas prise en charge avec le stockage DAS, car elles sont en concurrence pour le même contrôleur RAID matériel.

ONTAP Deploy garantit que le déploiement initial du cluster VNAS multinœud ne place pas plusieurs instances ONTAP Select du même cluster sur le même hôte. La figure suivante illustre un exemple de déploiement correct de deux clusters à quatre nœuds qui se croisent sur deux hôtes.

*Déploiement initial de clusters VNAS multinœuds*

image:ST_14.jpg["Déploiement initial de clusters VNAS multinœuds"]

Après le déploiement, les nœuds ONTAP Select peuvent être migrés entre les hôtes. Cela pourrait entraîner des configurations non optimales et non prises en charge, où deux ou plusieurs nœuds ONTAP Select d'un même cluster partagent le même hôte sous-jacent. NetApp recommande la création manuelle de règles d'anti-affinité de VM afin que VMware maintienne automatiquement la séparation physique entre les nœuds d'un même cluster, et pas seulement entre les nœuds d'une même paire HA.


NOTE: Les règles anti-affinité nécessitent que DRS soit activé sur le cluster ESX.

Consultez l'exemple suivant pour savoir comment créer une règle d'anti-affinité pour les machines virtuelles ONTAP Select . Si le cluster ONTAP Select contient plusieurs paires HA, tous les nœuds du cluster doivent être inclus dans cette règle.

image:ST_15.jpg["Règles VM/Hôte"]

image:ST_16.jpg["Modifier la règle VM/hôte"]

Deux ou plusieurs nœuds ONTAP Select du même cluster ONTAP Select peuvent potentiellement être trouvés sur le même hôte ESX pour l'une des raisons suivantes :

* DRS n'est pas présent en raison des limitations de licence VMware vSphere ou si DRS n'est pas activé.
* La règle anti-affinité DRS est contournée car une opération VMware HA ou une migration de machine virtuelle initiée par l'administrateur est prioritaire.


Notez ONTAP Deploy ne surveille pas proactivement les emplacements des machines virtuelles ONTAP Select . Cependant, une actualisation du cluster reflète cette configuration non prise en charge dans les journaux d' ONTAP Deploy :

image:ST_17.PNG["Journaux de déploiement ONTAP"]
